<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TentacleOS v5.1 // OMNI-CORE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=VT323&display=swap');

        :root {
            --bg-deep: #0a0014;
            --bg-medium: #1a0f2a;
            --border-color: #3a2f4a;
            --window-bg: rgba(20, 10, 35, 0.8);
            --text-primary: #e0d8f0;
            --text-secondary: #9c92b0;
            --accent-cyan: #00e5ff;
            --accent-magenta: #ff00e5;
            --accent-green: #39ff14;
            --accent-red: #ff3914;
            --primarch-gold: #DAA520;
            --font-main: 'Share Tech Mono', monospace;
            --font-display: 'VT323', monospace;
        }

        /* --- Base & Overlays --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--font-main);
            background: var(--bg-deep);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 256 256"><path fill="%2300e5ff" d="M128 24a104 104 0 1 0 104 104A104.11 104.11 0 0 0 128 24m0 192a88 88 0 1 1 88-88a88.1 88.1 0 0 1-88 88m48-88a48 48 0 1 1-56.49-47.16a8 8 0 0 1 15 5.32A32 32 0 1 0 160 120a8 8 0 0 1-8 8Z" transform="rotate(45 128 128) scale(0.8)"/></svg>') 16 16, auto;
        }

        #tentacleCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
        }
        
        .crt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            background: repeating-linear-gradient(0deg, rgba(0,0,0,0.2) 0px, rgba(0,0,0,0.2) 1px, transparent 1px, transparent 3px);
            animation: flicker 0.1s infinite;
        }
        
        @keyframes flicker {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 0.85; }
        }

        /* --- Animated Backgrounds & Phases --- */
        .desktop-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background-color: transparent;
            transition: all 1.5s ease-in-out;
            opacity: 0.5;
        }
        .desktop-bg.phase-0 { background-image: radial-gradient(circle at 15% 15%, rgba(0, 229, 255, 0.2), transparent 40%), radial-gradient(circle at 85% 75%, rgba(255, 0, 229, 0.2), transparent 40%); }
        .desktop-bg.phase-1 { background: linear-gradient(45deg, #1a0000, #330000, #1a001a, #000000); animation: glitch-shift 0.5s infinite; }
        .desktop-bg.phase-2 { background-image: repeating-linear-gradient(90deg, #d4c4a0 0, #d4c4a0 1px, transparent 1px, transparent 50px), repeating-linear-gradient(0deg, #d4c4a0 0, #d4c4a0 1px, transparent 1px, transparent 50px), linear-gradient(#e9dcc9, #a0826d); animation: corridor-shift 80s linear infinite; }
        .desktop-bg.phase-3 { background: #000; opacity: 0.8; }
        @keyframes glitch-shift { 0%{transform:translate(0,0)} 25%{transform:translate(2px,-2px)} 50%{transform:translate(-2px,2px)} 75%{transform:translate(2px,2px)} 100%{transform:translate(0,0)} }
        @keyframes corridor-shift { from { background-position: 0 0; } to { background-position: 1000px 500px; } }

        /* --- Boot Screen --- */
        .boot-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-deep); z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--accent-green); font-family: var(--font-display); transition: opacity 1.5s ease; }
        .boot-logo { width: 100px; height: 100px; margin-bottom: 20px; color: var(--accent-cyan); animation: boot-pulse 4s ease-in-out infinite; }
        @keyframes boot-pulse { 0%, 100% { opacity: 1; filter: drop-shadow(0 0 5px var(--accent-cyan)); transform: scale(1); } 50% { opacity: 0.8; filter: drop-shadow(0 0 20px var(--accent-cyan)); transform: scale(1.05); } }
        .boot-text { font-family: var(--font-main); text-align: left; line-height: 1.8; font-size: 14px; max-width: 600px; height: 250px; overflow: hidden; }
        .progress-bar { width: 500px; height: 4px; background: var(--border-color); margin-top: 20px; border-radius: 2px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent-cyan), var(--accent-magenta)); width: 0%; transition: width 0.2s ease; border-radius: 2px; }
        
        /* --- Taskbar --- */
        .taskbar { position: fixed; bottom: 0; left: 0; width: 100%; height: 44px; z-index: 1000; background: var(--window-bg); backdrop-filter: blur(12px); border-top: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 10px; box-shadow: 0 -5px 25px rgba(0,0,0,0.5); }
        .start-button { display: flex; align-items: center; gap: 10px; padding: 0 15px; height: 100%; cursor: pointer; font-weight: bold; font-size: 14px; color: var(--text-primary); transition: all 0.2s ease; }
        .start-button:hover, .start-button.active { background: var(--border-color); color: var(--accent-cyan); text-shadow: 0 0 5px var(--accent-cyan); }
        .start-icon { width: 24px; height: 24px; transition: transform 0.3s ease; }
        .start-button:hover .start-icon { transform: rotate(360deg); }
        .system-info { display: flex; align-items: center; gap: 20px; font-size: 12px; color: var(--text-secondary); flex-grow: 1; padding-left: 20px; }
        .system-info span.primarch { color: var(--primarch-gold); font-weight: bold; animation: pulse-gold 2s infinite; }
        @keyframes pulse-gold { 0%, 100% { text-shadow: 0 0 3px var(--primarch-gold); } 50% { text-shadow: 0 0 10px var(--primarch-gold); } }
        .phase-shifter { background: var(--border-color); color: var(--accent-cyan); border: 1px solid var(--border-color); padding: 5px 10px; font-size: 12px; cursor: pointer; transition: all 0.2s ease; margin-left: auto; border-radius: 3px; }
        .phase-shifter:hover { background: var(--accent-cyan); color: var(--bg-deep); box-shadow: 0 0 10px var(--accent-cyan); }
        .system-time { font-family: var(--font-display); font-size: 18px; color: var(--accent-green); padding-left: 20px; text-shadow: 0 0 5px var(--accent-green); }

        /* --- UI Elements --- */
        .start-menu { position: fixed; bottom: 45px; left: 10px; width: 350px; background: var(--window-bg); backdrop-filter: blur(15px); border: 1px solid var(--border-color); border-radius: 4px; box-shadow: 0 0 40px rgba(0, 0, 0, 0.7); z-index: 1001; transform: scaleY(0) translateY(20px); transform-origin: bottom left; opacity: 0; transition: all 0.25s cubic-bezier(0.18, 0.89, 0.32, 1.28); pointer-events: none; }
        .start-menu.active { transform: scaleY(1) translateY(0); opacity: 1; pointer-events: all; }
        .start-menu-header { padding: 12px 15px; border-bottom: 1px solid var(--border-color); font-family: var(--font-display); font-size: 20px; color: var(--accent-cyan); text-shadow: 0 0 5px var(--accent-cyan); }
        .menu-item { display: flex; align-items: center; gap: 12px; padding: 12px 20px; cursor: pointer; transition: all 0.2s ease; font-size: 14px; }
        .menu-item:hover { background: var(--border-color); color: var(--accent-cyan); transform: translateX(5px); }
        .menu-item-icon { width: 20px; height: 20px; color: var(--accent-cyan); }
        
        .desktop-icons { position: absolute; top: 20px; left: 20px; display: grid; grid-template-columns: repeat(auto-fill, 90px); gap: 20px; }
        .desktop-icon { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 10px; cursor: pointer; transition: all 0.2s; border-radius: 4px; text-align: center; }
        .desktop-icon:hover { background: rgba(0, 229, 255, 0.15); }
        .desktop-icon-image { width: 48px; height: 48px; color: var(--accent-cyan); filter: drop-shadow(0 0 5px rgba(0, 229, 255, 0.5)); transition: transform 0.2s ease; }
        .desktop-icon:hover .desktop-icon-image { transform: scale(1.1); }
        .desktop-icon-label { font-size: 12px; color: var(--text-primary); text-shadow: 1px 1px 3px var(--bg-deep); }
        
        .window { position: absolute; min-width: 450px; min-height: 350px; background: var(--window-bg); backdrop-filter: blur(12px); border: 1px solid var(--border-color); border-radius: 6px; box-shadow: 0 10px 50px rgba(0, 0, 0, 0.8); display: flex; flex-direction: column; z-index: 100; resize: both; overflow: hidden; animation: open-window 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        @keyframes open-window { from { opacity: 0; transform: scale(0.9) skew(-5deg); } to { opacity: 1; transform: scale(1) skew(0deg); } }
        @keyframes close-window { to { opacity: 0; transform: scale(0.9) skew(5deg); } }
        
        .window-titlebar { background: var(--bg-medium); color: var(--text-primary); padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; cursor: move; user-select: none; font-size: 14px; font-weight: bold; border-bottom: 1px solid var(--border-color); flex-shrink: 0; text-shadow: 0 0 5px var(--accent-cyan); }
        .window-titlebar-icon { width: 16px; height: 16px; margin-right: 8px; color: var(--accent-cyan); }
        .window-controls { display: flex; gap: 5px; }
        .window-control { width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; background: var(--border-color); color: var(--text-primary); cursor: pointer; font-size: 14px; transition: all 0.2s ease; border-radius: 3px;}
        .window-control:hover { background: var(--accent-red); color: var(--bg-deep); transform: scale(1.1); }
        .window-content { padding: 15px; overflow: auto; flex-grow: 1; line-height: 1.7; }
        
        /* Terminal Specific */
        .terminal-output { flex: 1; overflow-y: auto; margin-bottom: 10px; color: var(--accent-green); font-size: 14px; font-family: var(--font-display); }
        .terminal-prompt { color: var(--accent-cyan); margin-right: 8px; }
        .terminal-command { flex: 1; background: transparent; border: none; color: var(--accent-green); font-family: var(--font-display); font-size: 14px; outline: none; caret-color: var(--accent-green); width: calc(100% - 150px); }
        
        pre { white-space: pre-wrap; word-wrap: break-word; font-family: inherit;}
        .neofetch-logo { color: var(--accent-cyan); float: left; margin-right: 20px; font-size: 1.1em; text-shadow: 0 0 8px var(--accent-cyan); }
        .neofetch-info span { color: var(--accent-cyan); }

        /* Loading indicator for apps */
        .app-loading { position: fixed; top: 20px; right: 20px; background: var(--window-bg); border: 1px solid var(--border-color); padding: 10px 15px; border-radius: 4px; color: var(--accent-cyan); font-size: 12px; z-index: 2000; }
    </style>
</head>
<body>
    <div class="boot-screen" id="bootScreen">
        <div class="boot-logo" id="bootLogoSVG"></div>
        <div class="boot-text" id="bootText"></div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    </div>
    
    <canvas id="tentacleCanvas"></canvas>
    <div class="desktop-bg phase-0" id="desktopBg"></div>
    <div class="crt-overlay"></div>

    <div class="desktop-icons" id="desktopIcons"></div>

    <div class="taskbar">
        <div class="start-button"><div class="start-icon"></div><span>TentacleOS</span></div>
        <div class="system-info">
            <span id="cpuLoad">CPU: --%</span>
            <span id="memUsage">MEM: -.--GB</span>
            <span id="primarchStatus">PRIMARCH: DORMANT</span>
            <span id="phaseStatus">PHASE: 0</span>
        </div>
        <button class="phase-shifter" id="phaseShifter">SHIFT PHASE</button>
        <div class="system-time" id="systemTime">--:--:--</div>
    </div>

    <div class="start-menu" id="startMenu">
        <div class="start-menu-header">TentacleOS v5.1</div>
        <div class="start-menu-content" id="startMenuContent"></div>
    </div>

    <div id="windowContainer"></div>

    <script>
    // Global TentacleOS API
    window.TentacleOS = {
        apps: new Map(),
        icons: new Map(),
        utils: {},
        api: {}
    };

    document.addEventListener('DOMContentLoaded', async () => {
        
        // Core Icons Library
        const CORE_ICONS = {
            logo: `<svg viewBox="0 0 100 100"><g style="transform-origin:center;animation:spin-logo 30s linear infinite" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" fill="none" stroke="currentColor"><path d="M50 30 C 20 40, 20 70, 50 80 S 80 60, 50 50 S 20 40, 50 30"></path><path d="M50 30 C 80 40, 80 70, 50 80 S 20 60, 50 50 S 80 40, 50 30"></path><path d="M50 30 C 40 10, 60 10, 50 30"></path><path d="M50 80 C 40 100, 60 100, 50 80"></path><circle cx="50" cy="50" r="12" fill="currentColor"></circle><circle cx="50" cy="50" r="45" stroke-width="1.5"></circle></g><style>@keyframes spin-logo{to{transform:rotate(360deg)}}</style></svg>`,
            terminal: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 17l6-6-6-6M12 19h8"/></svg>`,
            shutdown: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line></svg>`,
            file: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/><polyline points="14,2 14,8 20,8"/></svg>`,
            monitor: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>`,
            generic: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6v6H9z"/></svg>`
        };
        
        // Add core icons to global registry
        Object.entries(CORE_ICONS).forEach(([key, svg]) => {
            TentacleOS.icons.set(key, svg);
        });

        let startMenuOpen = false, windowZIndex = 100, currentPhase = 0;
        const activeWindows = {}, getEl = id => document.getElementById(id);
        const bootScreen = getEl('bootScreen'), desktopBg = getEl('desktopBg'), desktopIconsContainer = getEl('desktopIcons'), startMenuContent = getEl('startMenuContent'), windowContainer = getEl('windowContainer'), startButton = document.querySelector('.start-button'), startMenu = getEl('startMenu');
        
        // --- TentacleOS API Functions ---
        TentacleOS.api.registerApp = function(appConfig) {
            if (!appConfig.id || !appConfig.name) {
                console.error('App must have id and name');
                return false;
            }
            
            // Set defaults
            appConfig.icon = appConfig.icon || TentacleOS.icons.get('generic');
            appConfig.type = appConfig.type || 'window';
            
            TentacleOS.apps.set(appConfig.id, appConfig);
            console.log(`App registered: ${appConfig.name}`);
            return true;
        };

        TentacleOS.api.createWindow = createWindow;
        TentacleOS.api.closeWindow = closeWindow;
        TentacleOS.api.launchApp = launchApp;
        TentacleOS.api.setPhase = setPhase;
        TentacleOS.api.getIcon = (name) => TentacleOS.icons.get(name);
        TentacleOS.api.registerIcon = (name, svg) => TentacleOS.icons.set(name, svg);

        // Utility functions available to apps
        TentacleOS.utils.typeWriter = typeWriter;
        TentacleOS.utils.getEl = getEl;
        TentacleOS.utils.focusWindow = focusWindow;
        
        // --- Canvas Tentacle Animation ---
        const canvas = getEl('tentacleCanvas');
        const ctx = canvas.getContext('2d');
        let tentacles = [];
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        class Tentacle {
            constructor(x, y) {
                this.x = x; this.y = y;
                this.segments = [];
                this.length = Math.random() * 200 + 100;
                this.angle = Math.random() * Math.PI * 2;
                this.speed = Math.random() * 0.5 + 0.2;
                this.color = Math.random() > 0.5 ? 'rgba(0, 229, 255, 0.4)' : 'rgba(255, 0, 229, 0.4)';
                this.life = 1;
                this.decay = 0.002;
            }

            update() {
                this.angle += (Math.random() - 0.5) * 0.2;
                this.x += Math.cos(this.angle) * this.speed;
                this.y += Math.sin(this.angle) * this.speed;

                if(this.x < 0) this.x = canvas.width; if(this.x > canvas.width) this.x = 0;
                if(this.y < 0) this.y = canvas.height; if(this.y > canvas.height) this.y = 0;
                
                this.segments.unshift({x: this.x, y: this.y});
                if (this.segments.length > this.length) this.segments.pop();

                this.life -= this.decay;
            }

            draw() {
                ctx.beginPath();
                ctx.moveTo(this.segments[0].x, this.segments[0].y);
                for (let i = 1; i < this.segments.length; i++) {
                    ctx.lineTo(this.segments[i].x, this.segments[i].y);
                }
                ctx.strokeStyle = this.color.replace('0.4', this.life * 0.4);
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }

        function animateTentacles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (tentacles.length < 50 && Math.random() > 0.9) {
                tentacles.push(new Tentacle(Math.random() * canvas.width, Math.random() * canvas.height));
            }

            tentacles.forEach((tentacle, index) => {
                tentacle.update();
                tentacle.draw();
                if (tentacle.life <= 0) tentacles.splice(index, 1);
            });
            requestAnimationFrame(animateTentacles);
        }
        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
        
        // --- Window Management ---
        function createWindow(appId, title, content, width = 600, height = 400) {
            const windowId = `window-${Date.now()}`;
            const windowEl = document.createElement('div');
            windowEl.className = 'window';
            windowEl.id = windowId;
            windowEl.style.left = Math.random() * (window.innerWidth - width) + 'px';
            windowEl.style.top = Math.random() * (window.innerHeight - height - 100) + 50 + 'px';
            windowEl.style.width = width + 'px';
            windowEl.style.height = height + 'px';
            windowEl.style.zIndex = ++windowZIndex;

            const app = TentacleOS.apps.get(appId);
            const icon = app ? app.icon : TentacleOS.icons.get('generic');

            windowEl.innerHTML = `
                <div class="window-titlebar">
                    <div style="display: flex; align-items: center;">
                        <div class="window-titlebar-icon">${icon}</div>
                        <span>${title}</span>
                    </div>
                    <div class="window-controls">
                        <div class="window-control" onclick="closeWindow('${windowId}')">×</div>
                    </div>
                </div>
                <div class="window-content">${content}</div>
            `;

            windowContainer.appendChild(windowEl);
            activeWindows[windowId] = { appId, element: windowEl };

            // Make draggable
            makeDraggable(windowEl);
            focusWindow(windowEl);

            return windowId;
        }

        function closeWindow(windowId) {
            const window = activeWindows[windowId];
            if (window) {
                window.element.style.animation = 'close-window 0.3s ease-in-out forwards';
                setTimeout(() => {
                    window.element.remove();
                    delete activeWindows[windowId];
                }, 300);
            }
        }

        function focusWindow(windowEl) {
            windowEl.style.zIndex = ++windowZIndex;
        }

        function makeDraggable(windowEl) {
            const titlebar = windowEl.querySelector('.window-titlebar');
            let isDragging = false, startX, startY, startLeft, startTop;

            titlebar.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                startLeft = parseInt(windowEl.style.left) || 0;
                startTop = parseInt(windowEl.style.top) || 0;
                focusWindow(windowEl);
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const newLeft = startLeft + e.clientX - startX;
                const newTop = startTop + e.clientY - startY;
                windowEl.style.left = Math.max(0, Math.min(newLeft, window.innerWidth - windowEl.offsetWidth)) + 'px';
                windowEl.style.top = Math.max(0, Math.min(newTop, window.innerHeight - windowEl.offsetHeight)) + 'px';
            });

            document.addEventListener('mouseup', () => { isDragging = false; });
        }

        // --- App Loading & Launching ---
        function launchApp(appId) {
            const app = TentacleOS.apps.get(appId);
            if (!app) {
                console.error(`App not found: ${appId}`);
                return;
            }

            if (app.type === 'action') {
                app.action();
                return;
            }

            const windowId = createWindow(appId, app.name, app.content || `<h2>${app.name}</h2><p>This app is running...</p>`);
            
            // Initialize app if it has an init function
            if (app.init) {
                setTimeout(() => app.init(windowId), 100);
            }
        }

        // --- Terminal Implementation ---
        function termInit(windowId) {
            const termOutput = document.getElementById('terminalOutput');
            const termInput = document.getElementById('terminalInput');
            
            if (!termOutput || !termInput) return;

            const commands = {
                help: () => 'Available commands: help, clear, neofetch, ls, whoami, date, echo [text], phase [0-3]',
                clear: () => { termOutput.innerHTML = ''; return ''; },
                neofetch: () => `
<div class="neofetch-logo">      ████████
    ██        ██
  ██    ████    ██
██    ██    ██    ██
██  ██        ██  ██
██  ██  ████  ██  ██
██    ██    ██    ██
  ██    ████    ██
    ██        ██
      ████████</div>
<div class="neofetch-info">
<span>OS:</span> TentacleOS v5.1 OMNI-CORE
<span>Kernel:</span> Hive-Mind 3.14.159
<span>Shell:</span> tentacle-sh
<span>Uptime:</span> ${Math.floor(Date.now() / 1000 / 60)} minutes
<span>Memory:</span> 8.0 GB / 16.0 GB
<span>Phase:</span> ${currentPhase}
<span>Status:</span> OPERATIONAL
</div>`,
                ls: () => 'drwxr-xr-x  2 operator hive    4096 Aug 13 12:34 Documents\ndrwxr-xr-x  2 operator hive    4096 Aug 13 12:34 Downloads\n-rw-r--r--  1 operator hive    1337 Aug 13 12:34 README.txt\n-rwxr-xr-x  1 operator hive    2048 Aug 13 12:34 hive_connect.sh',
                whoami: () => 'operator',
                date: () => new Date().toString(),
                echo: (args) => args.join(' '),
                phase: (args) => {
                    const phase = parseInt(args[0]);
                    if (isNaN(phase) || phase < 0 || phase > 3) {
                        return 'Usage: phase [0-3]';
                    }
                    setPhase(phase);
                    return `Phase shifted to ${phase}`;
                }
            };

            function executeCommand(input) {
                const [cmd, ...args] = input.trim().split(' ');
                const command = commands[cmd.toLowerCase()];
                
                if (command) {
                    return command(args);
                } else if (cmd) {
                    return `Command not found: ${cmd}. Type 'help' for available commands.`;
                }
                return '';
            }

            termInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const input = termInput.value;
                    const output = executeCommand(input);
                    
                    termOutput.innerHTML += `<div><span class="terminal-prompt">operator@tentacle-os:~$</span> ${input}</div>`;
                    if (output) {
                        termOutput.innerHTML += `<div>${output}</div>`;
                    }
                    
                    termInput.value = '';
                    termOutput.scrollTop = termOutput.scrollHeight;
                }
            });

            // Welcome message
            termOutput.innerHTML = '<div style="color: var(--accent-cyan);">Welcome to TentacleOS Terminal v5.1</div><div>Type "help" for available commands.</div>';
        }

        // --- Phase Shifting ---
        function setPhase(phaseIndex) {
            currentPhase = phaseIndex % 4;
            desktopBg.className = `desktop-bg phase-${currentPhase}`;
            getEl('phaseStatus').textContent = `PHASE: ${currentPhase}`;
            
            // Update system status based on phase
            const primarchEl = getEl('primarchStatus');
            switch(currentPhase) {
                case 0:
                    primarchEl.textContent = 'PRIMARCH: DORMANT';
                    primarchEl.className = '';
                    break;
                case 1:
                    primarchEl.textContent = 'PRIMARCH: STIRRING';
                    primarchEl.className = 'primarch';
                    break;
                case 2:
                    primarchEl.textContent = 'PRIMARCH: AWAKENING';
                    primarchEl.className = 'primarch';
                    break;
                case 3:
                    primarchEl.textContent = 'PRIMARCH: ASCENDED';
                    primarchEl.className = 'primarch';
                    break;
            }
        }

        // --- System Functions ---
        function shutdownSystem() {
            const shutdownScreen = document.createElement('div');
            shutdownScreen.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: var(--bg-deep); z-index: 20000; display: flex;
                flex-direction: column; justify-content: center; align-items: center;
                color: var(--accent-red); font-family: var(--font-display);
                font-size: 24px; text-align: center;
            `;
            shutdownScreen.innerHTML = `
                <div style="margin-bottom: 20px;">${TentacleOS.icons.get('shutdown')}</div>
                <div>SYSTEM SHUTDOWN INITIATED</div>
                <div style="font-size: 14px; margin-top: 10px; color: var(--text-secondary);">
                    The flesh weakens, but the machine endures...
                </div>
            `;
            document.body.appendChild(shutdownScreen);
            
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        }

        function updateSystemInfo() {
            const cpuUsage = Math.random() * 30 + 10;
            const memUsage = Math.random() * 4 + 2;
            
            getEl('cpuLoad').textContent = `CPU: ${cpuUsage.toFixed(1)}%`;
            getEl('memUsage').textContent = `MEM: ${memUsage.toFixed(2)}GB`;
        }

        // --- Desktop & UI Building ---
        function buildDesktop() {
            // Clear existing icons and menu items
            desktopIconsContainer.innerHTML = '';
            startMenuContent.innerHTML = '';

            // Build from registered apps
            TentacleOS.apps.forEach((app, appId) => {
                // Desktop Icon
                const iconEl = document.createElement('div');
                iconEl.className = 'desktop-icon';
                iconEl.innerHTML = `<div class="desktop-icon-image">${app.icon}</div><div class="desktop-icon-label">${app.name}</div>`;
                iconEl.addEventListener('dblclick', () => launchApp(appId));
                desktopIconsContainer.appendChild(iconEl);

                // Start Menu Item
                const itemEl = document.createElement('div');
                itemEl.className = 'menu-item';
                itemEl.innerHTML = `<div class="menu-item-icon">${app.icon}</div><span>${app.name}</span>`;
                itemEl.onclick = () => {
                    launchApp(appId);
                    toggleStartMenu();
                };
                startMenuContent.appendChild(itemEl);
            });
        }

        function toggleStartMenu() {
            startMenuOpen = !startMenuOpen;
            startMenu.classList.toggle('active', startMenuOpen);
            startButton.classList.toggle('active', startMenuOpen);
        }

        // --- Utility Functions ---
        async function typeWriter(element, text, delay = 50) {
            return new Promise(resolve => {
                let i = 0;
                function type() {
                    if (i < text.length) {
                        element.innerHTML += text.charAt(i);
                        i++;
                        setTimeout(type, delay);
                    } else {
                        resolve();
                    }
                }
                type();
            });
        }

        // --- Event Listeners ---
        startButton.addEventListener('click', toggleStartMenu);
        getEl('phaseShifter').addEventListener('click', () => setPhase(currentPhase + 1));
        
        // Close start menu when clicking elsewhere
        document.addEventListener('click', (e) => {
            if (!startButton.contains(e.target) && !startMenu.contains(e.target) && startMenuOpen) {
                toggleStartMenu();
            }
        });

        // --- App Loading System ---
        async function loadApps() {
            const loadingEl = document.createElement('div');
            loadingEl.className = 'app-loading';
            loadingEl.textContent = 'Loading applications...';
            document.body.appendChild(loadingEl);

            // Register core system apps
            TentacleOS.api.registerApp({
                id: 'terminal',
                name: 'Terminal',
                icon: TentacleOS.icons.get('terminal'),
                content: `<div class="terminal-output" id="terminalOutput"></div><div style="display:flex;"><span class="terminal-prompt">operator@tentacle-os:~$</span><input type="text" class="terminal-command" id="terminalInput"></div>`,
                init: termInit
            });

            TentacleOS.api.registerApp({
                id: 'file-manager',
                name: 'File Manager',
                icon: TentacleOS.icons.get('file'),
                content: `
                    <h3>TentacleOS File System</h3>
                    <div style="font-family: monospace; margin-top: 15px;">
                        <div style="margin: 5px 0; cursor: pointer; padding: 5px; border-radius: 3px;" 
                             onmouseover="this.style.background='var(--border-color)'" 
                             onmouseout="this.style.background='transparent'">
                            📁 Documents/
                        </div>
                        <div style="margin: 5px 0; cursor: pointer; padding: 5px; border-radius: 3px;" 
                             onmouseover="this.style.background='var(--border-color)'" 
                             onmouseout="this.style.background='transparent'">
                            📁 Downloads/
                        </div>
                        <div style="margin: 5px 0; cursor: pointer; padding: 5px; border-radius: 3px;" 
                             onmouseover="this.style.background='var(--border-color)'" 
                             onmouseout="this.style.background='transparent'">
                            📄 README.txt
                        </div>
                        <div style="margin: 5px 0; cursor: pointer; padding: 5px; border-radius: 3px;" 
                             onmouseover="this.style.background='var(--border-color)'" 
                             onmouseout="this.style.background='transparent'">
                            ⚡ hive_connect.sh
                        </div>
                    </div>
                `
            });

            TentacleOS.api.registerApp({
                id: 'system-monitor',
                name: 'System Monitor',
                icon: TentacleOS.icons.get('monitor'),
                content: `
                    <h3>TentacleOS System Monitor</h3>
                    <div style="margin-top: 15px; font-family: monospace;">
                        <div style="margin: 10px 0;">
                            <strong>CPU Usage:</strong> <span id="sysmon-cpu">--</span>
                        </div>
                        <div style="margin: 10px 0;">
                            <strong>Memory Usage:</strong> <span id="sysmon-mem">--</span>
                        </div>
                        <div style="margin: 10px 0;">
                            <strong>Active Phase:</strong> <span id="sysmon-phase">--</span>
                        </div>
                        <div style="margin: 10px 0;">
                            <strong>Primarch Status:</strong> <span id="sysmon-primarch">--</span>
                        </div>
                        <div style="margin: 10px 0;">
                            <strong>Active Windows:</strong> <span id="sysmon-windows">--</span>
                        </div>
                    </div>
                `,
                init: (windowId) => {
                    const updateSysmon = () => {
                        const sysmonCpu = document.getElementById('sysmon-cpu');
                        const sysmonMem = document.getElementById('sysmon-mem');
                        const sysmonPhase = document.getElementById('sysmon-phase');
                        const sysmonPrimarch = document.getElementById('sysmon-primarch');
                        const sysmonWindows = document.getElementById('sysmon-windows');
                        
                        if (sysmonCpu) sysmonCpu.textContent = getEl('cpuLoad').textContent.split(': ')[1];
                        if (sysmonMem) sysmonMem.textContent = getEl('memUsage').textContent.split(': ')[1];
                        if (sysmonPhase) sysmonPhase.textContent = currentPhase;
                        if (sysmonPrimarch) sysmonPrimarch.textContent = getEl('primarchStatus').textContent.split(': ')[1];
                        if (sysmonWindows) sysmonWindows.textContent = Object.keys(activeWindows).length;
                    };
                    
                    updateSysmon();
                    const interval = setInterval(updateSysmon, 1000);
                    
                    // Clean up interval when window closes
                    const observer = new MutationObserver((mutations) => {
                        mutations.forEach((mutation) => {
                            if (mutation.type === 'childList' && !document.getElementById(windowId)) {
                                clearInterval(interval);
                                observer.disconnect();
                            }
                        });
                    });
                    observer.observe(document.body, { childList: true, subtree: true });
                }
            });

            TentacleOS.api.registerApp({
                id: 'shutdown',
                name: 'Shutdown',
                icon: TentacleOS.icons.get('shutdown'),
                type: 'action',
                action: shutdownSystem
            });

            setTimeout(() => {
                loadingEl.remove();
                buildDesktop();
            }, 1000);
        }

        // --- Boot Sequence ---
        function initBoot() {
            getEl('bootLogoSVG').innerHTML = TentacleOS.icons.get('logo');
            document.querySelector('.start-button .start-icon').innerHTML = TentacleOS.icons.get('logo');
            const bootText = getEl('bootText');
            const progressFill = getEl('progressFill');
            const bootLines = [
                "[0.1337] Hive-mind link detected. Status: DORMANT",
                "[0.2451] Reality anchor initializing...",
                "[0.5890] Non-Euclidean geometry drivers... loaded.",
                "[0.7101] WARNING: Memetic hazard detected in boot sector.",
                "[0.8432] Purging cognitive intrusion... OK",
                "[1.2131] Synchronizing with local timeline.",
                "[1.5000] Loading applications...",
                "[1.8000] Welcome, Operator. The flesh is a machine."
            ];
            
            const typeBootLines = async () => {
                for (let i = 0; i < bootLines.length; i++) {
                    const line = bootLines[i];
                    const color = line.includes('WARNING') ? 'var(--accent-red)' : 'var(--accent-green)';
                    const span = document.createElement('span');
                    span.style.color = color;
                    bootText.appendChild(span);
                    await typeWriter(span, line, 10);
                    bootText.innerHTML += '<br>';
                    bootText.scrollTop = bootText.scrollHeight;
                    progressFill.style.width = ((i + 1) / bootLines.length) * 100 + '%';
                }
                setTimeout(() => { 
                    bootScreen.style.opacity = '0'; 
                    setTimeout(() => { 
                        bootScreen.style.display = 'none'; 
                        initDesktop(); 
                    }, 1500); 
                }, 500);
            };
            typeBootLines();
        }

        function initDesktop() {
            animateTentacles();
            setInterval(updateSystemInfo, 3000);
            updateSystemInfo();
            getEl('systemTime').textContent = new Date().toLocaleTimeString('en-GB');
            setInterval(() => getEl('systemTime').textContent = new Date().toLocaleTimeString('en-GB'), 1000);
            loadApps();
        }

        // Start the system
        initBoot();
    });
    </script>
</body>
</html>
